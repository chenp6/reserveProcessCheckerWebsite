<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>各校備取進度查詢（多系組）</title>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="./css/loadingHamster.css" type="text/css">
    <link rel="stylesheet" href="./css/style.css" type="text/css">
</head>

<body>
    <div id="loadingPage" class="loading-overlay">
        <div aria-label="Orange and tan hamster running in a metal wheel" role="img" class="wheel-and-hamster">
            <div class="wheel"></div>
            <div class="hamster">
                <div class="hamster__body">
                    <div class="hamster__head">
                        <div class="hamster__ear"></div>
                        <div class="hamster__eye"></div>
                        <div class="hamster__nose"></div>
                    </div>
                    <div class="hamster__limb hamster__limb--fr"></div>
                    <div class="hamster__limb hamster__limb--fl"></div>
                    <div class="hamster__limb hamster__limb--br"></div>
                    <div class="hamster__limb hamster__limb--bl"></div>
                    <div class="hamster__tail"></div>
                </div>
            </div>
            <div class="spoke"></div>
        </div>
        <div class="loading-text">資料載入中，請稍候<br>Thanks for your patience!ヾ(•ω•`)o</div>
    </div>

    <div id="loadedPage">
        <div class="wrapper">
            <header class="header">
                <div class="brand">
                    <div class="brand-logo">RP</div>
                    <div>
                        <p class="brand-title">各校備取進度查詢（多系組）</p>
                        <div class="tag" aria-hidden="true">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 2L19 21L12 17L5 21L12 2Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                            一次輸入，多組備取同步查詢
                        </div>
                    </div>
                </div>
                <nav class="nav" aria-label="主導覽">
                    <a href="./">快速查詢</a>
                    <a href="./group.html">多系組查詢</a>
                    <a href="./notice.html">最新公告</a>
                </nav>
            </header>

            <div class="grid">
                <main class="card">
                    <h2>查詢流程</h2>
                    <div class="notice">
                        <strong>操作步驟：</strong><br>
                        1. 於「建立查詢碼」中新增想查詢的學校/考試/系組，可選填考生編號或准考證號。<br>
                        2. 按下「建立/更新查詢碼」並複製查詢碼。<br>
                        3. 於「進行多系組查詢」貼上查詢碼後送出，即可一次取得所有結果。
                    </div>

                    <div class="panel" id="createQueryPanel">
                        <header class="panel-header">
                            <button class="toggleBtn" id="createQueryToggle" onclick="openToggle('createQuery')">▶</button>
                            <div>
                                <p class="panel-title">建立查詢碼</p>
                                <p class="panel-subtitle">挑選學校、考試類別與系組，整合為一組查詢碼。</p>
                            </div>
                        </header>
                        <div class="panel-body toggleContent" id="createQueryContent">
                            <div class="actions">
                                <div>
                                    <div class="label">學校</div>
                                    <select id="schoolSelect" aria-label="學校選擇">
                                        <option value="">請選擇學校</option>
                                        <option value="NTU">國立臺灣大學</option>
                                        <option value="NYCU">國立陽明交通大學</option>
                                        <option value="NCCU">國立政治大學</option>
                                        <option value="NCKU">國立成功大學</option>
                                        <option value="CCU">國立中正大學</option>
                                        <option value="NCU">國立中央大學</option>
                                        <option value="NSYSU">國立中山大學</option>
                                        <option value="UST">台灣聯合大學系統</option>
                                    </select>
                                </div>
                                <div>
                                    <div class="label">考試類別</div>
                                    <select id="examSelect" aria-label="考試類別選擇"></select>
                                </div>
                                <div>
                                    <div class="label">系組</div>
                                    <select id="groupSelect" aria-label="系組選擇"></select>
                                </div>
                                <div>
                                    <div class="label">考生編號/准考證號碼（非必填）</div>
                                    <input type="text" id="userIdInput" name="userId" aria-label="考生編號或准考證號碼">
                                </div>
                            </div>

                            <div class="links">
                                <button onclick="addNewQuery()">新增查詢</button>
                                <button class="secondary" onclick="reset()">清除表單</button>
                            </div>

                            <table id="queryListTable" class="table">
                                <thead>
                                    <tr>
                                        <th>學校</th>
                                        <th>考試類別</th>
                                        <th>系組</th>
                                        <th>考生編號/准考證號碼</th>
                                        <th>刪除</th>
                                    </tr>
                                </thead>
                                <tbody id="queryListTableBody"></tbody>
                            </table>

                            <div class="links">
                                <button onclick="createQueryCode()">建立/更新查詢碼</button>
                                <input type="text" placeholder="按下建立查詢碼後，結果顯示於此" id="queryCodeOutput" readonly>
                                <button class="secondary" onclick="copyQueryCode()">複製查詢碼</button>
                            </div>
                        </div>
                    </div>

                    <div class="panel" id="groupQueryPanel" style="margin-top: 12px;">
                        <header class="panel-header">
                            <button class="toggleBtn" id="groupQueryToggle" onclick="openToggle('groupQuery')">▶</button>
                            <div>
                                <p class="panel-title">進行多系組查詢</p>
                                <p class="panel-subtitle">貼上查詢碼，一鍵取得所有系組與個人備取資訊。</p>
                            </div>
                        </header>
                        <div class="panel-body toggleContent" id="groupQueryContent">
                            <div class="actions">
                                <div>
                                    <div class="label">查詢碼</div>
                                    <input type="text" id="queryCodeInput" name="queryCodeInput" aria-label="查詢碼輸入">
                                </div>
                            </div>
                            <div class="links">
                                <button onclick="getGroupQuery()">開始查詢</button>
                            </div>
                            <div class="alert warn">備取進度為爬蟲資料，若學校未更新官方網站，資訊可能有落差。</div>
                            <div class="alert">備註：備取進度表示目前最後一位報到者的位置，尚未有遞補時會顯示「目前尚未有遞補名額」。</div>
                            <table id="resultListTable" class="table">
                                <thead>
                                    <tr>
                                        <th>學校</th>
                                        <th>考試類別</th>
                                        <th>系組</th>
                                        <th>系組備取狀況</th>
                                        <th>考生編號/准考證號碼</th>
                                        <th>考生查詢結果</th>
                                    </tr>
                                </thead>
                                <tbody id="resultListTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </main>

                <aside class="card">
                    <h2>公告與提醒</h2>
                    <div class="alert warn">此網站的遞補資訊僅供參考，若學校未即時更新官方資訊，內容可能有延遲。</div>
                    <div class="alert">為節省記憶體空間，可能會移除非當年度之個人備取進度。</div>
                    <div class="notice">感謝大家使用此網站！若方便，歡迎填寫 <a href="https://forms.gle/sHJdbu3zWAKMz4g6A" target="_blank" rel="noopener">滿意度調查問卷</a> 回饋建議。</div>
                    <div class="links">
                        <a href="./notice.html">查看完整公告</a>
                        <a href="./">回到快速查詢</a>
                    </div>
                </aside>
            </div>

            <div class="footer">Copyright (C) 2022 Nawsome. 本網站提供資訊僅供參考，請以各校官方公告為準。</div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        // location.href = "./fix.html";
        window.onload = () => {
            onStopLoading();
            initSelect2();
        }

        reset();
        const urlHeader = ".";

        function initSelect2() {
            const placeholders = {
                schoolSelect: "請選擇學校",
                examSelect: "請選擇考試類別",
                groupSelect: "請選擇系組"
            };

            ["#schoolSelect", "#examSelect", "#groupSelect"].forEach((selector) => {
                const id = selector.replace("#", "");
                const $select = $(selector);
                if ($select.hasClass("select2-hidden-accessible")) {
                    $select.select2("destroy");
                }
                $select.select2({
                    width: "100%",
                    placeholder: placeholders[id] || "請選擇",
                    allowClear: true,
                    language: {
                        noResults: () => "沒有符合的項目"
                    }
                });
            });
        }

        function updateSelectOptions(selector, optionsHtml) {
            const $select = $(selector);
            $select.html(optionsHtml);
            $select.val("").trigger("change");
        }

        function reset() {
            document.getElementById("schoolSelect").selectedIndex = 0;
            document.getElementById("examSelect").selectedIndex = 0;
            document.getElementById("groupSelect").selectedIndex = 0;
            document.getElementById("userIdInput").value = "";
            document.getElementById("queryCodeOutput").value = "";
            document.getElementById("queryCodeInput").value = "";
            $("#schoolSelect, #examSelect, #groupSelect").val("").trigger("change");
        }

        function onLoading() {
            document.getElementById('loadedPage').style.opacity = "30%";
            document.getElementById('loadingPage').style.display = "flex";
        }

        function onStopLoading() {
            document.getElementById('loadingPage').style.display = "none";
            document.getElementById('loadedPage').style.opacity = "100%";
        }

        document.getElementById("schoolSelect").onchange = () => {
            selectSchool()
        };

        async function selectSchool() {
            const selectedSchool = document.getElementById("schoolSelect").value;
            if (selectedSchool === "") {
                updateSelectOptions("#examSelect", "<option value=''>請選擇考試類別</option>");
                updateSelectOptions("#groupSelect", "<option value=''>請選擇系組</option>");
                document.getElementById("userIdInput").value = "";
                return;
            }

            const url = urlHeader + `/getExamSelect?school=${selectedSchool}`;
            onLoading();
            const res = await fetch(url, {
                method: 'GET',
            })
            const examList = await res.json();
            onStopLoading();

            let html = " <option value = '' > 請選擇考試類別 </option>"

            for (const exam of examList) {
                html += `<option  value = "${exam.year}_${exam.examNo}" >  ${exam.name}</option>`
            }
            updateSelectOptions("#examSelect", html);
            updateSelectOptions("#groupSelect", "<option value=''>請選擇系組</option>");
            document.getElementById("userIdInput").value = "";
        }

        document.getElementById("examSelect").onchange = () => {
            selectExam();
        }

        async function selectExam() {
            const selectedSchool = document.getElementById("schoolSelect").value;
            const selectedExamValue = document.getElementById("examSelect").value;
            if (selectedSchool === "" || selectedExamValue === "") {
                updateSelectOptions("#groupSelect", "<option value=''>請選擇系組</option>");
                document.getElementById("userIdInput").value = "";
                return;
            }

            const [examYear, examNo] = selectedExamValue.split(/_(.+)/);

            const url = urlHeader + `/getGroupSelect?school=${selectedSchool}&examNo=${examNo}&year=${examYear}`;

            onLoading();
            const res = await fetch(url, {
                method: 'GET',
            })
            const groupList = await res.json();
            onStopLoading();

            let html = " <option value = '' > 請選擇系組 </option>"
            for (const group of groupList) {
                html += `<option value = ${group.groupNo} >  ${group.name}</option>`
            }
            updateSelectOptions("#groupSelect", html);
            document.getElementById("userIdInput").value = "";

        }

        //toggles settings
        function openToggle(prefix) {
            document.getElementById(`${prefix}Content`).style.display = "flex";
            document.getElementById(`${prefix}Toggle`).onclick = () => {
                closeToggle(prefix)
            };
            document.getElementById(`${prefix}Toggle`).innerText = "▼";
        }

        function closeToggle(prefix) {
            document.getElementById(`${prefix}Content`).style.display = "none";
            document.getElementById(`${prefix}Toggle`).onclick = () => {
                openToggle(prefix);
            }
            document.getElementById(`${prefix}Toggle`).innerText = "▶";
        }

        function addNewQuery() {
            const schoolSelect = document.getElementById("schoolSelect");
            const examSelect = document.getElementById("examSelect");
            const groupSelect = document.getElementById("groupSelect");
            const userId = document.getElementById("userIdInput");
            if (schoolSelect.value == "" || examSelect.value == "" || groupSelect.value == "") {
                return;
            }


            const queryListTableBody = document.getElementById('queryListTableBody');
            const row = queryListTableBody.insertRow(-1);

            const schoolCell = row.insertCell(0);
            const examCell = row.insertCell(1);
            const groupCell = row.insertCell(2);
            const userIdCell = row.insertCell(3);
            const toDelCell = row.insertCell(4);

            schoolCell.value = schoolSelect.value;
            examCell.value = examSelect.value;
            groupCell.value = groupSelect.value;
            userIdCell.value = userId.value;
            schoolCell.innerHTML = schoolSelect.options[schoolSelect.selectedIndex].text;
            examCell.innerHTML = examSelect.options[examSelect.selectedIndex].text;
            groupCell.innerHTML = groupSelect.options[groupSelect.selectedIndex].text;
            userIdCell.innerHTML = userId.value;
            toDelCell.innerHTML = `<button onclick='deleteQuery(this)'>刪除</button>`

            userId.value = "";
        }

        function deleteQuery(delBtn) {
            const row = delBtn.parentNode.parentNode; //delBtn.parentNode(td).parentNode(tr)
            row.parentNode.removeChild(row);
        }

        function createQueryCode() {
            const queryListTable = document.getElementById('queryListTableBody');
            const queryList = [];



            for (let row of queryListTable.rows) {
                const selectedExam = row.cells[1].value.split(/_(.*)/);
                const examYear = selectedExam[0];
                const examNo = selectedExam[1];
                queryList.push({
                    school: {
                        name: row.cells[0].innerText,
                        value: row.cells[0].value
                    },
                    examNo: {
                        name: row.cells[1].innerText,
                        value: examNo
                    },
                    groupNo: {
                        name: row.cells[2].innerText,
                        value: row.cells[2].value,
                    },
                    userId: row.cells[3].value,
                    year: examYear
                })
            }

            document.getElementById("queryCodeOutput").value = jsonToBase64({
                result: queryList
            });

        }

        function copyQueryCode() {
            const text = document.getElementById("queryCodeOutput");
            text.select();
            document.execCommand("copy");
        }



        async function getGroupQuery() {

            const queryListJson = encodeBase64ToJson(document.getElementById("queryCodeInput").value);
            const queryList = queryListJson.result;
            console.log(queryList)

            const resultListTableBody = document.getElementById('resultListTableBody');
            resultListTableBody.innerHTML = "";

            for (let query of queryList) {
                const row = resultListTableBody.insertRow(-1);
                const schoolCell = row.insertCell(0);
                const examCell = row.insertCell(1);
                const groupCell = row.insertCell(2);
                const groupResultCell = row.insertCell(3);

                schoolCell.innerHTML = query.school.name;
                examCell.innerHTML = query.examNo.name;
                groupCell.innerHTML = query.groupNo.name;
                groupResultCell.innerHTML = await getReserveProcess(query.school.value, query.examNo.value, query.groupNo.value, query.year);

                if (query.userId != "") {
                    const userIdCell = row.insertCell(4);
                    const userResultCell = row.insertCell(5);

                    userIdCell.innerHTML = query.userId;
                    userResultCell.innerHTML = await getUserRank(query.school.value, query.examNo.value, query.groupNo.value, query.userId, query.year);
                }
            }
        }




        async function getUserRank(queriedSchool, queriedExam, queriedGroup, queriedUserId, queriedYear) {
            if (queriedSchool == "" || queriedExam == "" || queriedGroup == "" || queriedUserId == "" || queriedYear == "") {
                return;
            }


            const groupId = queriedSchool + "_" + queriedExam + "_" + queriedGroup;

            onLoading();
            const url = urlHeader + `/getUserRank?groupId=${groupId}&userId=${queriedUserId}&year=${queriedYear}`;
            const res = await fetch(url, {
                method: 'GET',
            })
            const userRank = await res.json();
            onStopLoading();

            if (userRank == null)
                return `查無此考生`;
            else {
                return `名次:${userRank.rank}<br>報到狀況:${userRank.status}`;
            }
        }


        async function getReserveProcess(queriedSchool, queriedExam, queriedGroup, queriedYear) {
            if (queriedSchool == "" || queriedExam == "" || queriedGroup == "" || queriedYear == "") {
                return;
            }
            const url = urlHeader + `/getReserveProcess?school=${queriedSchool}&examNo=${queriedExam}&groupNo=${queriedGroup}&year=${queriedYear}`;
            onLoading();
            const res = await fetch(url, {
                method: 'GET',
            })
            onStopLoading();

            const group = await res.json();
            return `已報到人數/正取招收人數:${group.registered}/${group.want}<br>=>備取進度:${group.currentReserve}`
        }

        function jsonToBase64(jsonObj) {
            const jsonString = JSON.stringify(jsonObj)
            return window.btoa(unescape(encodeURIComponent(jsonString)))
        }

        function encodeBase64ToJson(base64String) {
            const jsonString = decodeURIComponent(escape(window.atob(base64String)))
            return JSON.parse(jsonString)
        }
    </script>
</body>

</html>
